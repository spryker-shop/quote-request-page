{% extends template('page-layout-customer', 'CustomerPage') %}

{% define data = {
    title: 'quote_request_page.quote_request' | trans,
    quoteRequestForm: _view.quoteRequestForm,
    quoteRequest: _view.quoteRequestForm.vars.value,
    shipmentGroups: _view.shipmentGroups | default([]),
    shipmentTotal: _view.shipmentTotal,
} %}

{% set quote = data.quoteRequest.latestVersion.quote %}
{% set hasMultiShipments = data.shipmentGroups | length > 1 %}

{% block breadcrumbs %}
    {% include molecule('breadcrumb') with {
        data: {
            steps: [
                {
                    label: 'customer.account' | trans,
                    url: path('customer/overview'),
                },
                {
                    label: 'quote_request_page.quote_request' | trans,
                    url: path('quote-request')
                },
                {
                    label: 'quote_request_page.quote_request.actions.edit' | trans,
                },
            ],
        },
    } only %}
{% endblock %}

{% block content %}

    {% if not quote or quote.items is empty %}
        <div class="box text-center">
            {% include atom('icon') with {
                modifiers: ['biggest'],
                class: 'text-alt',
                data: {
                    name: 'shopping-cart',
                },
            } only %}
            <h6>{{ 'cart.empty' | trans }}</h6>
        </div>
    {% else %}

        {{ form_start(data.quoteRequestForm) }}

        <div class="grid">
            <div class="col col--sm-12 col--xl-8">
                <div class="box">
                    {% for child in data.quoteRequestForm.latestVersion.metadata %}
                        <div class="col col--sm-12 col--xl-6">
                            <div class="box">
                                {{ form_row(child) }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="col col--sm-12 col--xl-4">
                <div class="box">
                    <h6>{{ "quote_request_page.quote_request.labels.information" | trans }}</h6>
                    <hr class="box__separator">
                    <p>{{ 'quote_request_page.quote_request.labels.date' | trans }}:
                        <b>{{ data.quoteRequest.createdAt | formatDateTime }}</b>
                    </p>
                    <p>{{ 'quote_request_page.quote_request.labels.status' | trans }}:
                        <span class="request-status request-status--{{ data.quoteRequest.status }}">{{ ('quote_request.status.' ~ data.quoteRequest.status) | trans }}</span>
                    </p>
                    {% if data.quoteRequest.validUntil %}
                        <p>{{ 'quote_request_page.quote_request.labels.valid_till' | trans }}:
                            <b>{{ data.quoteRequest.validUntil | formatDateTime }}</b>
                        </p>
                    {% endif %}
                    <hr class="box__separator">
                    <h6>{{ "quote_request_page.quote_request.labels.version_information" | trans }}</h6>
                    <hr class="box__separator">
                    <p>{{ 'quote_request_page.quote_request.labels.history' | trans }}:
                        <b>{{ data.quoteRequest.latestVersion ? data.quoteRequest.latestVersion.versionReference : null }}</b>
                    </p>
                </div>
            </div>
        </div>
        <div class="grid">
            <div class="col col--sm-12 col--xl-8">
                {% if quote and quote.priceMode is not empty %}
                    <div class="box">
                        {% include molecule('price-mode') with {
                            data: {
                                priceMode: quote.priceMode,
                            },
                        } only %}
                    </div>
                {% endif %}

                {% if hasMultiShipments %}
                    {% for shipmentGroup in data.shipmentGroups %}
                        <div class="grid grid--stretch grid--justify">
                            <div class="col col--sm-12 col--lg-12">
                                <div class="box">
                                    <h4>{{ 'quote_request_page.quote_request.shipment_counter' | trans({
                                            '%index%': loop.index,
                                            '%length%': data.shipmentGroups | length,
                                        }) }}</h4>
                                    <hr>
                                    <h6><strong>{{ 'checkout.step.summary.products' | trans }}</strong></h6>

                                    {% widget 'QuoteConfiguredBundleWidget' args [quote, shipmentGroup.items] with {
                                        data: {
                                            isEditable: false,
                                            isQuantitySummaryVisible: true,
                                        },
                                    } only %}
                                    {% endwidget %}

                                    {% set cartItems = shipmentGroup.items | filter(item => item.configuredBundleItem is not defined or item.configuredBundleItem is empty) %}
                                    {% for cartItem in cartItems %}
                                        {% embed molecule('product-cart-item', 'CartPage') ignore missing with {
                                            data: {
                                                product: cartItem,
                                            },
                                            embed: {
                                                priceMode: quote.priceMode,
                                                currency: quote.currency,
                                            },
                                        } only %}
                                            {% block additionalInformation %}
                                                {% include molecule('quote-request-item-summary', 'QuoteRequestPage') with {
                                                    data: {
                                                        priceMode: embed.priceMode,
                                                        unitPrice: data.product.unitPrice | money(true, embed.currency.code),
                                                        subtotalPrice: data.product.sumSubtotalAggregation | money(true, embed.currency.code),
                                                        cartItem: data.product,
                                                        currency: embed.currency,
                                                    },
                                                } only %}
                                            {% endblock %}

                                            {% block actions %}
                                                {% if data.product.amountSalesUnit is empty %}
                                                    {{ 'cart.item_quantity' | trans }}:
                                                    <strong>{{ data.product.quantity }}</strong>

                                                    {% if data.product.quantitySalesUnit %}
                                                        {% set value = data.product.quantitySalesUnit.value %}
                                                        {% set precision = data.product.quantitySalesUnit.precision %}
                                                        {% set salesUnitName = data.product.quantitySalesUnit.productMeasurementUnit.name | default('') %}

                                                        <p>
                                                            <small class="text-secondary">
                                                                [= {{ value / precision }} {{ salesUnitName | trans }}]
                                                            </small>
                                                        </p>
                                                    {% endif %}
                                                {% endif %}
                                            {% endblock %}
                                        {% endembed %}
                                    {% endfor %}
                                    {% include molecule('quote-request-shipment-information', 'QuoteRequestPage') with {
                                        data: {
                                            shipment: shipmentGroup.shipment,
                                            showAddress: true,
                                        },
                                    } only %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    {% widget 'QuoteConfiguredBundleWidget' args [quote] with {
                        data: {
                            isEditable: false,
                        },
                    } only %}
                    {% endwidget %}

                    {% set cartItems = quote.items | filter(item => item.configuredBundleItem is not defined or item.configuredBundleItem is empty) %}
                    {% for cartItem in cartItems %}
                        {% embed molecule('product-cart-item', 'CartPage') ignore missing with {
                            data: {
                                product: cartItem,
                            },
                            embed: {
                                priceMode: quote.priceMode,
                                currency: quote.currency,
                            },
                        } only %}
                            {% block additionalInformation %}
                                {% include molecule('quote-request-item-summary', 'QuoteRequestPage') with {
                                    data: {
                                        priceMode: embed.priceMode,
                                        unitPrice: data.product.unitPrice | money(true, embed.currency.code),
                                        subtotalPrice: data.product.sumSubtotalAggregation | money(true, embed.currency.code),
                                        cartItem: data.product,
                                        currency: embed.currency,
                                    },
                                } only %}
                                {% block addAddressButton %}
                                    <a href="{{ url('quote-request/checkout-address', {quoteRequestReference: data.quoteRequestReference}) }}"
                                       class="button button--expand button--add-address"
                                       title="{{ 'quote_request_page.quote_request.cta_add_address' | trans }}"
                                        {{ qa('cart-go-to-address') }}>
                                        {{ 'quote_request_page.quote_request.cta_add_address' | trans }}
                                    </a>
                                {% endblock %}

                                {% block editAddressButton %}
                                    <a href="{{ url('quote-request/checkout-address', {quoteRequestReference: data.quoteRequestReference}) }}"
                                       class="button button--expand button--edit-address"
                                       title="{{ 'quote_request_page.quote_request.cta_edit_address' | trans }}"
                                        {{ qa('cart-go-to-address') }}>
                                        {{ 'quote_request_page.quote_request.cta_edit_address' | trans }}
                                    </a>
                                {% endblock %}

                                {% block addShipmentButton %}
                                    <a href="{{ url('quote-request/checkout-shipment', {quoteRequestReference: data.quoteRequestReference}) }}"
                                       class="button button--expand button--add-shipment"
                                       title="{{ 'quote_request_page.quote_request.cta_add_shipment_method' | trans }}"
                                        {{ qa('cart-go-to-shipment') }}>
                                        {{ 'quote_request_page.quote_request.cta_add_shipment_method' | trans }}
                                    </a>
                                {% endblock %}

                                {% block editShipmentButton %}
                                    <a href="{{ url('quote-request/checkout-shipment', {quoteRequestReference: data.quoteRequestReference}) }}"
                                       class="button button--expand button--edit-shipment"
                                       title="{{ 'quote_request_page.quote_request.cta_edit_shipment_method' | trans }}"
                                        {{ qa('cart-go-to-shipment') }}>
                                        {{ 'quote_request_page.quote_request.cta_edit_shipment_method' | trans }}
                                    </a>
                                {% endblock %}
                            {% endblock %}

                            {% block actions %}
                                {% if data.product.amountSalesUnit is empty %}
                                    {{ 'cart.item_quantity' | trans }}:
                                    <strong>{{ data.product.quantity }}</strong>

                                    {% if data.product.quantitySalesUnit %}
                                        {% set value = data.product.quantitySalesUnit.value %}
                                        {% set precision = data.product.quantitySalesUnit.precision %}
                                        {% set salesUnitName = data.product.quantitySalesUnit.productMeasurementUnit.name | default('') %}

                                        <p>
                                            <small class="text-secondary">
                                                [= {{ value / precision }} {{ salesUnitName | trans }}]
                                            </small>
                                        </p>
                                    {% endif %}
                                {% endif %}
                            {% endblock %}
                        {% endembed %}
                    {% endfor %}

                    <h4 class="spacing-x spacing-top spacing-top--big">{{ 'quote_request_page.quote_request.title_shipment_method' | trans }}</h4>
                    {% include molecule('quote-request-shipment-information', 'QuoteRequestPage') with {
                        data: {
                            shipment: quote.shipment,
                        },
                    } only %}
                {% endif %}
            </div>

            <div class="col col--sm-12 col--xl-4">

                {% include molecule('quote-request-delivery-summary', 'QuoteRequestPage') ignore missing with {
                    class: 'list spacing-y',
                    data: {
                        quote: quote,
                        hasMultiShipments: hasMultiShipments,
                        isEditable: true,
                    }
                } only %}

                <div class="box">
                    {% include molecule('quote-request-cart-summary', 'QuoteRequestPage') with {
                        data: {
                            cart: quote,
                            shipmentGroups: data.shipmentGroups,
                            shipmentTotal: data.shipmentTotal,
                        },
                    } only %}
                </div>
                <div class="box spacing-top spacing-top--big">
                    <a class="button button--expand button--hollow"
                       href="{{ url('quote-request/details', {quoteRequestReference: data.quoteRequest.quoteRequestReference}) }}" data-init-single-click>
                        {{ 'quote_request_page.quote_request.actions.back_to_view' | trans }}
                    </a>
                    <hr class="box__separator">
                    <a class="button button--expand button--edit-items"
                       href="{{ url('quote-request/edit-items', { quoteRequestReference: (data.quoteRequest.quoteRequestReference) }) }}" data-init-single-click>
                        {{ 'quote_request_page.quote_request.actions.edit_items' | trans }}
                    </a>
                    <hr class="box__separator">
                    <button type="submit" name="save" class="button button--expand button--success">
                        {{ 'quote_request_page.quote_request.actions.save' | trans }}
                    </button>
                    <hr class="box__separator">
                    <button type="submit" name="sendToUser" class="button button--expand button--success">
                        {{ 'quote_request_page.quote_request.actions.send_to_agent' | trans }}
                    </button>
                </div>
            </div>
        </div>

        {{ form_end(data.quoteRequestForm) }}
    {% endif %}
{% endblock %}
